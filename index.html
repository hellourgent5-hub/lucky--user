<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6amMart User App (Complete)</title>
    <!-- Tailwind CSS is loaded for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles for Mobile-First Design */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f7f7f7;
            padding-bottom: 64px; /* Space for fixed footer */
        }
        .app-header {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 20;
        }
        .app-view {
            min-height: calc(100vh - 120px); /* Ensures view takes up space */
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            padding: 16px;
        }
        .product-card {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s;
        }
        .category-list-container {
            display: flex;
            overflow-x: scroll;
            -webkit-overflow-scrolling: touch;
            gap: 10px;
            padding: 0 16px;
        }
        .category-list-container::-webkit-scrollbar { display: none; }
        
        .service-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }
        .service-item img {
            transition: transform 0.2s;
        }
        .service-item:hover img {
            transform: scale(1.05);
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Global Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/70 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500"></div>
        <p class="ml-4 text-green-700 font-semibold">Loading...</p>
    </div>

    <!-- Global Message/Modal Box -->
    <div id="message-box" class="fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 bg-green-500 text-white rounded-lg shadow-lg z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        Item added to cart!
    </div>

    <!-- Main Content Containers -->
    <div id="app-container" class="relative">
        <!-- 1. AUTH VIEWS (Login/Signup) -->
        <div id="auth-view" class="app-view p-6 flex flex-col items-center justify-center h-screen bg-gray-50">
            <h2 class="text-3xl font-bold text-green-600 mb-6">Welcome to 6amMart</h2>
            
            <div id="login-form" class="w-full max-w-sm bg-white p-6 rounded-xl shadow-lg transition-all duration-300">
                <h3 class="text-xl font-semibold mb-4 text-center">Login</h3>
                <input type="email" id="login-email" placeholder="Email" class="w-full p-3 mb-4 border border-gray-300 rounded-lg">
                <input type="password" id="login-password" placeholder="Password" class="w-full p-3 mb-6 border border-gray-300 rounded-lg">
                <button onclick="handleLogin()" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition">Log In</button>
                <button onclick="showSignup()" class="w-full mt-4 text-green-600 text-sm hover:text-green-700">Need an account? Sign Up</button>
            </div>
            
            <div id="signup-form" class="w-full max-w-sm bg-white p-6 rounded-xl shadow-lg hidden transition-all duration-300">
                <h3 class="text-xl font-semibold mb-4 text-center">Sign Up</h3>
                <input type="email" id="signup-email" placeholder="Email" class="w-full p-3 mb-4 border border-gray-300 rounded-lg">
                <input type="password" id="signup-password" placeholder="Password" class="w-full p-3 mb-6 border border-gray-300 rounded-lg">
                <button onclick="handleSignup()" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition">Create Account</button>
                <button onclick="showLogin()" class="w-full mt-4 text-green-600 text-sm hover:text-green-700">Already have an account? Log In</button>
            </div>
        </div>

        <!-- 2. HOME LANDING PAGE (Multi-Service Selector) -->
        <div id="home-view" class="app-view hidden">
            <section class="p-4">
                <img src="https://placehold.co/600x150/4CAF50/ffffff?text=World+Vegetarian+Day+Banner" alt="Banner" class="w-full rounded-xl shadow-md mb-6">
                
                <h3 class="text-lg font-semibold mb-3">All Services</h3>
                <div class="service-grid">
                    <!-- Service Items -->
                    <div class="service-item flex flex-col items-center p-3 bg-white rounded-xl shadow-md cursor-pointer hover:bg-gray-50" onclick="navigateTo('food-view')">
                        <img src="https://placehold.co/50x50/e8f5e9/4CAF50?text=G" class="rounded-lg mb-2" alt="Grocery">
                        <span class="text-xs font-medium">Grocery</span>
                    </div>
                    <div class="service-item flex flex-col items-center p-3 bg-white rounded-xl shadow-md cursor-pointer hover:bg-gray-50" onclick="navigateTo('food-view')">
                        <img src="https://placehold.co/50x50/e8f5e9/4CAF50?text=P" class="rounded-lg mb-2" alt="Pharmacy">
                        <span class="text-xs font-medium">Pharmacy</span>
                    </div>
                    <div class="service-item flex flex-col items-center p-3 bg-white rounded-xl shadow-md cursor-pointer hover:bg-gray-50" onclick="navigateTo('food-view')">
                        <img src="https://placehold.co/50x50/e8f5e9/4CAF50?text=F" class="rounded-lg mb-2" alt="Food">
                        <span class="text-xs font-medium">Food</span>
                    </div>
                    <div class="service-item flex flex-col items-center p-3 bg-white rounded-xl shadow-md cursor-pointer hover:bg-gray-50" onclick="navigateTo('food-view')">
                        <img src="https://placehold.co/50x50/e8f5e9/4CAF50?text=E" class="rounded-lg mb-2" alt="E-Commerce">
                        <span class="text-xs font-medium">E-Commerce</span>
                    </div>
                    <div class="service-item flex flex-col items-center p-3 bg-white rounded-xl shadow-md cursor-pointer hover:bg-gray-50" onclick="navigateTo('food-view')">
                        <img src="https://placehold.co/50x50/e8f5e9/4CAF50?text=L" class="rounded-lg mb-2" alt="Logistics">
                        <span class="text-xs font-medium">Logistics</span>
                    </div>
                </div>
            </section>
            
            <section class="p-4 pt-0">
                <h3 class="text-lg font-semibold mb-3">Featured Stores</h3>
                <div id="featured-stores" class="flex overflow-x-scroll pb-2 space-x-3">
                    <!-- Stores will be dynamically loaded here -->
                    <div class="flex-shrink-0 w-40 h-20 bg-gray-200 rounded-lg animate-pulse"></div>
                    <div class="flex-shrink-0 w-40 h-20 bg-gray-200 rounded-lg animate-pulse"></div>
                </div>
            </section>
        </div>

        <!-- 3. FOOD LISTING VIEW (The Marketplace) -->
        <div id="food-view" class="app-view hidden">
            <!-- Categories -->
            <section class="py-3 bg-white shadow-sm">
                <h3 class="text-lg font-semibold mb-2 px-4">Categories</h3>
                <div id="category-list" class="category-list-container">
                    <a href="#" class="category-item flex-shrink-0 text-xs font-medium p-2 rounded-lg bg-green-600 text-white" data-category="all">All</a>
                    <a href="#" class="category-item flex-shrink-0 text-xs font-medium p-2 rounded-lg bg-gray-100 hover:bg-gray-200" data-category="fastfood">Fast Food</a>
                    <a href="#" class="category-item flex-shrink-0 text-xs font-medium p-2 rounded-lg bg-gray-100 hover:bg-gray-200" data-category="drinks">Drinks</a>
                    <a href="#" class="category-item flex-shrink-0 text-xs font-medium p-2 rounded-lg bg-gray-100 hover:bg-gray-200" data-category="desserts">Desserts</a>
                </div>
            </section>

            <!-- Product Grid -->
            <section class="pt-4">
                <h3 class="text-lg font-semibold px-4 mb-2">Popular Items Nearby</h3>
                <div id="product-grid" class="product-grid">
                    <!-- Products will be dynamically loaded here -->
                    <div class="w-full h-48 bg-gray-200 rounded-xl animate-pulse"></div>
                    <div class="w-full h-48 bg-gray-200 rounded-xl animate-pulse"></div>
                    <div class="w-full h-48 bg-gray-200 rounded-xl animate-pulse"></div>
                    <div class="w-full h-48 bg-gray-200 rounded-xl animate-pulse"></div>
                </div>
            </section>
        </div>
        
        <!-- 4. CART VIEW -->
        <div id="cart-view" class="app-view hidden p-4">
            <h2 class="text-2xl font-bold mb-6 text-green-700">Your Cart</h2>
            <div id="cart-items" class="space-y-4">
                <!-- Cart items dynamically loaded -->
            </div>
            
            <div id="cart-summary" class="bg-white p-4 rounded-xl shadow-lg mt-6">
                <h3 class="text-xl font-semibold mb-3">Order Summary</h3>
                <div class="flex justify-between mb-2">
                    <span class="text-gray-600">Subtotal:</span>
                    <span id="cart-subtotal" class="font-medium">$0.00</span>
                </div>
                <div class="flex justify-between mb-4">
                    <span class="text-gray-600">Delivery Fee:</span>
                    <span class="font-medium">$5.00</span>
                </div>
                <div class="flex justify-between border-t pt-3">
                    <span class="text-xl font-bold">Total:</span>
                    <span id="cart-total" class="text-xl font-bold text-green-600">$5.00</span>
                </div>
            </div>
            
            <button onclick="handleCheckout()" id="checkout-button" class="w-full bg-green-600 text-white p-3 rounded-xl font-semibold mt-6 disabled:bg-green-300">Proceed to Checkout</button>
            <button onclick="clearCart()" id="clear-cart-button" class="w-full bg-red-100 text-red-600 p-3 rounded-xl font-semibold mt-3 disabled:opacity-50 hover:bg-red-200 transition">Clear Cart</button>

            <!-- Checkout Modal -->
            <div id="checkout-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 flex items-center justify-center hidden">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm">
                    <h3 class="text-2xl font-bold mb-4 text-green-600">Place Order</h3>
                    <p class="mb-4">Total amount: <span id="modal-total" class="font-bold text-lg text-red-500"></span></p>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Payment Method</label>
                        <select id="payment-method" class="w-full p-2 border rounded-lg">
                            <option value="cod">Cash on Delivery (COD)</option>
                            <option value="card" disabled>Credit/Debit Card (Unavailable)</option>
                        </select>
                    </div>

                    <button onclick="placeOrder()" class="w-full bg-red-500 text-white p-3 rounded-lg font-semibold hover:bg-red-600 transition">Confirm Order & Pay</button>
                    <button onclick="hideCheckoutModal()" class="w-full mt-3 text-gray-500 hover:text-gray-700 text-sm">Cancel</button>
                </div>
            </div>
        </div>

        <!-- 5. ACCOUNT/ORDERS VIEW -->
        <div id="account-view" class="app-view hidden p-4">
            <h2 class="text-2xl font-bold mb-6 text-green-700">My Account</h2>

            <div class="bg-white p-4 rounded-xl shadow-lg mb-6">
                <p class="font-semibold mb-2">User: <span id="account-user-id" class="font-normal text-sm text-gray-500"></span></p>
                <button onclick="handleLogout()" class="bg-red-500 text-white p-2 rounded-lg text-sm font-semibold hover:bg-red-600 transition">Log Out</button>
            </div>
            
            <h3 class="text-xl font-bold mb-4">My Orders</h3>
            <div id="orders-list" class="space-y-3">
                <!-- Orders dynamically loaded -->
                <p class="text-gray-500">No orders found.</p>
            </div>
        </div>
    </div>

    <!-- Global Footer Navigation -->
    <footer id="main-footer" class="fixed bottom-0 left-0 w-full bg-white flex justify-around p-3 shadow-2xl z-30 hidden">
        <button class="nav-button flex flex-col items-center text-green-600" data-view="home-view">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span class="text-xs">Home</span>
        </button>
        <button class="nav-button flex flex-col items-center text-gray-400" data-view="food-view">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
            <span class="text-xs">Shop</span>
        </button>
        <button class="nav-button flex flex-col items-center text-gray-400 relative" data-view="cart-view">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            <span id="cart-count" class="absolute top-0 right-3 bg-red-500 text-white text-xs font-bold px-1 rounded-full leading-4 hidden">0</span>
            <span class="text-xs">Cart</span>
        </button>
        <button class="nav-button flex flex-col items-center text-gray-400" data-view="account-view">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            <span class="text-xs">Account</span>
        </button>
    </footer>

    <!-- Firebase SDK Imports (MUST be 'type="module"') -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('Debug'); // Uncomment for debugging Firebase logs
        
        // --- Global Variables (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = null;
        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) {
            console.error("Error parsing __firebase_config:", e);
        }
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- App State ---
        window.app = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.cart = []; // Local mirror of cart state
        window.orders = []; // Local mirror of orders state
        window.isFirebaseReady = false; // Flag to track successful initialization

        const DELIVERY_FEE = 5.00;
        const API_BASE_URL = 'https://lucky-backend-xh9.onrender.com'; 

        // Mock Product Data
        const MOCK_PRODUCTS = [
            { id: 'p1', name: 'Premium Burger Combo', price: 12.50, category: 'fastfood', imageUrl: 'https://placehold.co/150x150/10B981/ffffff?text=Burger' },
            { id: 'p2', name: 'Fresh Salad Bowl', price: 8.75, category: 'healthy', imageUrl: 'https://placehold.co/150x150/059669/ffffff?text=Salad' },
            { id: 'p3', name: 'Iced Coffee', price: 4.00, category: 'drinks', imageUrl: 'https://placehold.co/150x150/F59E0B/ffffff?text=Coffee' },
            { id: 'p4', name: 'Chocolate Sundae', price: 6.25, category: 'desserts', imageUrl: 'https://placehold.co/150x150/DC2626/ffffff?text=Sundae' },
            { id: 'p5', name: 'Spicy Tacos (3 Pcs)', price: 9.50, category: 'fastfood', imageUrl: 'https://placehold.co/150x150/84CC16/ffffff?text=Tacos' },
            { id: 'p6', name: 'Lemonade', price: 3.50, category: 'drinks', imageUrl: 'https://placehold.co/150x150/3B82F6/ffffff?text=Lemonade' },
        ];


        // --- Utility Functions ---

        function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
        
        function showMessage(msg) {
            const box = document.getElementById('message-box');
            box.textContent = msg;
            box.classList.remove('opacity-0', 'pointer-events-none');
            box.classList.add('opacity-100');
            setTimeout(() => {
                box.classList.add('opacity-0', 'pointer-events-none');
            }, 3000);
        }

        // --- Routing and Navigation ---

        const views = ['auth-view', 'home-view', 'food-view', 'cart-view', 'account-view'];

        window.navigateTo = function(targetViewId) {
            views.forEach(viewId => {
                const view = document.getElementById(viewId);
                if (view) {
                    if (viewId === targetViewId) {
                        view.classList.remove('hidden');
                    } else {
                        view.classList.add('hidden');
                    }
                }
            });
            // Update footer active state
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('text-green-600');
                button.classList.add('text-gray-400');
                if (button.dataset.view === targetViewId) {
                    button.classList.remove('text-gray-400');
                    button.classList.add('text-green-600');
                }
            });
            
            // Special handlers for view changes
            if (targetViewId === 'food-view') {
                fetchProducts();
            }
            // Ensure footer is shown only after successful auth
            const mainFooter = document.getElementById('main-footer');
            if (window.userId) {
                 mainFooter.classList.remove('hidden');
            } else {
                 mainFooter.classList.add('hidden');
            }
        }
        
        // Add navigation listeners for the footer
        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo(button.dataset.view);
            });
        });


        // --- Firestore References ---

        function getCartRef() {
            // Private data storage path: /artifacts/{appId}/users/{userId}/cart/current
            return doc(window.db, "artifacts", appId, "users", window.userId, "cart", "current");
        }
        
        function getOrdersCollectionRef() {
            // Private data collection path: /artifacts/{appId}/users/{userId}/orders
            return collection(window.db, "artifacts", appId, "users", window.userId, "orders");
        }

        // --- Authentication Logic ---

        async function initAuth() {
            if (!firebaseConfig) {
                console.error("Firebase configuration not available. Cannot initialize Firebase.");
                showMessage("App Error: Firebase configuration missing.");
                hideLoading();
                return;
            }

            try {
                window.app = initializeApp(firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);
                
                // IMPORTANT: Set flag ONLY after successful initialization
                window.isFirebaseReady = true; 

                // Listen for auth state changes
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('account-user-id').textContent = user.uid.substring(0, 12) + '...';
                        navigateTo('home-view');
                        initFirestoreListeners();
                    } else {
                        window.userId = null;
                        navigateTo('auth-view');
                    }
                    hideLoading();
                });

                // Initial sign-in attempt
                showLoading();
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    // Sign in anonymously if no custom token is provided
                    await signInAnonymously(window.auth);
                }
            } catch (error) {
                console.error("Firebase initialization or initial sign-in failed:", error);
                showMessage(`Initialization Error: ${error.message}`);
                hideLoading();
            }
        }
        
        window.handleLogin = async function() {
            if (!window.isFirebaseReady || !window.auth) {
                return showMessage("System not ready. Please wait or refresh.");
            }
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (!email || !password) return showMessage("Please enter email and password.");
            showLoading();
            try {
                await signInWithEmailAndPassword(window.auth, email, password);
                showMessage("Logged in successfully!");
            } catch (error) {
                showMessage(`Login Failed: ${error.message}`);
            }
            hideLoading();
        }

        window.handleSignup = async function() {
            if (!window.isFirebaseReady || !window.auth) {
                return showMessage("System not ready. Please wait or refresh.");
            }
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            if (!email || !password || password.length < 6) return showMessage("Password must be 6 characters.");
            showLoading();
            try {
                await createUserWithEmailAndPassword(window.auth, email, password);
                showMessage("Account created and logged in!");
            } catch (error) {
                showMessage(`Signup Failed: ${error.message}`);
            }
            hideLoading();
        }

        window.handleLogout = async function() {
            if (!window.isFirebaseReady || !window.auth) return;
            showLoading();
            try {
                await signOut(window.auth);
                window.cart = [];
                window.orders = [];
                showMessage("Logged out.");
            } catch (error) {
                showMessage(`Logout Failed: ${error.message}`);
            }
            hideLoading();
        }

        window.showSignup = function() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.remove('hidden');
        }

        window.showLogin = function() {
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        }

        // --- Firestore Listeners ---

        function initFirestoreListeners() {
            if (!window.userId || !window.db) return;
            
            // 1. Cart Listener
            onSnapshot(getCartRef(), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    // Safety check for array type (though Firebase usually handles this)
                    const data = docSnapshot.data();
                    window.cart = Array.isArray(data.items) ? data.items : []; 
                } else {
                    window.cart = [];
                }
                updateCartUI();
            }, (error) => console.error("Error listening to cart:", error));

            // 2. Orders Listener
            const ordersQuery = query(getOrdersCollectionRef());
            onSnapshot(ordersQuery, (snapshot) => {
                window.orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOrders();
            }, (error) => console.error("Error listening to orders:", error));
        }

        // --- Cart CRUD Operations ---

        async function updateCartInFirestore(newCart) {
            if (!window.userId || !window.db) return showMessage("Authentication required.");
            try {
                // Use setDoc for the single document where cart data resides
                await setDoc(getCartRef(), { 
                    items: newCart, 
                    userId: window.userId, 
                    updatedAt: serverTimestamp() 
                }, { merge: true });
            } catch (error) {
                console.error("Failed to update cart:", error);
                showMessage("Error updating cart.");
            }
        }

        window.addToCart = function(product) {
            if (!window.isFirebaseReady || !window.userId) return showMessage("Please log in to add items.");
            
            const existingItem = window.cart.find(item => item.id === product.id);
            let newCart;
            
            if (existingItem) {
                newCart = window.cart.map(item => 
                    item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item
                );
            } else {
                newCart = [...window.cart, { ...product, quantity: 1 }];
            }
            
            updateCartInFirestore(newCart);
            showMessage(`${product.name} added to cart!`);
        }

        window.updateCartItemQuantity = function(productId, delta) {
            if (!window.isFirebaseReady || !window.userId) return;
            
            let newCart = window.cart.map(item => {
                if (item.id === productId) {
                    const newQuantity = item.quantity + delta;
                    if (newQuantity <= 0) return null; // Mark for removal
                    return { ...item, quantity: newQuantity };
                }
                return item;
            }).filter(item => item !== null); // Remove null marked items
            
            updateCartInFirestore(newCart);
        }

        window.clearCart = function() {
            if (!window.isFirebaseReady || !window.userId) return showMessage("Please log in first.");
            if (window.cart.length === 0) return showMessage("Cart is already empty.");
            
            // Clear the cart by setting the items array to empty
            updateCartInFirestore([]);
            showMessage("Cart cleared successfully!");
        }

        // --- UI Rendering ---

        function updateCartUI() {
            const cartItemsContainer = document.getElementById('cart-items');
            const cartCountElement = document.getElementById('cart-count');
            const subtotalElement = document.getElementById('cart-subtotal');
            const totalElement = document.getElementById('cart-total');
            const checkoutButton = document.getElementById('checkout-button');
            const clearCartButton = document.getElementById('clear-cart-button');

            const cartTotalQuantity = window.cart.reduce((sum, item) => sum + item.quantity, 0);

            if (window.cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-center text-gray-500 py-10">Your cart is empty.</p>';
                cartCountElement.classList.add('hidden');
                checkoutButton.disabled = true;
                clearCartButton.disabled = true;
                subtotalElement.textContent = '$0.00';
                totalElement.textContent = `$${DELIVERY_FEE.toFixed(2)}`;
                document.getElementById('modal-total').textContent = `$${DELIVERY_FEE.toFixed(2)}`;
                return;
            }

            checkoutButton.disabled = false;
            clearCartButton.disabled = false;
            cartCountElement.classList.remove('hidden');
            cartCountElement.textContent = cartTotalQuantity;

            let subtotal = 0;
            let cartHTML = '';

            window.cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;

                cartHTML += `
                    <div class="flex items-center bg-white p-3 rounded-xl shadow-sm">
                        <img src="${item.imageUrl}" alt="${item.name}" class="w-12 h-12 object-cover rounded-md mr-4">
                        <div class="flex-grow">
                            <p class="font-semibold text-sm truncate">${item.name}</p>
                            <p class="text-green-600 font-bold text-sm">$${item.price.toFixed(2)}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="updateCartItemQuantity('${item.id}', -1)" class="w-6 h-6 bg-gray-200 rounded-full text-gray-700">-</button>
                            <span class="font-semibold">${item.quantity}</span>
                            <button onclick="updateCartItemQuantity('${item.id}', 1)" class="w-6 h-6 bg-green-600 rounded-full text-white">+</button>
                        </div>
                    </div>
                `;
            });

            const total = subtotal + DELIVERY_FEE;
            cartItemsContainer.innerHTML = cartHTML;
            subtotalElement.textContent = `$${subtotal.toFixed(2)}`;
            totalElement.textContent = `$${total.toFixed(2)}`;
            document.getElementById('modal-total').textContent = `$${total.toFixed(2)}`;
        }
        
        function renderOrders() {
            const ordersList = document.getElementById('orders-list');
            
            if (window.orders.length === 0) {
                ordersList.innerHTML = '<p class="text-gray-500">No orders found.</p>';
                return;
            }
            
            let ordersHTML = '';
            // Sort in memory by createdAt descending
            window.orders.sort((a, b) => {
                const dateA = a.createdAt ? new Date(a.createdAt.toDate()).getTime() : 0;
                const dateB = b.createdAt ? new Date(b.createdAt.toDate()).getTime() : 0;
                return dateB - dateA;
            });
            
            window.orders.forEach(order => {
                const date = order.createdAt ? new Date(order.createdAt.toDate()).toLocaleDateString() : 'N/A';
                const total = order.total.toFixed(2);
                const statusColor = order.status === 'Pending' ? 'yellow' : 'green';

                ordersHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-${statusColor}-500">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold text-sm">Order ID: ${order.id.substring(0, 8)}</span>
                            <span class="text-xs text-gray-500">${date}</span>
                        </div>
                        <p class="font-bold text-xl text-green-600 mb-2">$${total}</p>
                        <p class="text-sm">Status: <span class="font-bold text-${statusColor}-500">${order.status}</span></p>
                        <details class="mt-2">
                            <summary class="text-sm font-medium text-gray-500 cursor-pointer">Details (${order.items.length} items)</summary>
                            <ul class="mt-2 text-xs space-y-1">
                                ${order.items.map(item => `<li>${item.name} x ${item.quantity} ($${(item.price * item.quantity).toFixed(2)})</li>`).join('')}
                            </ul>
                        </details>
                    </div>
                `;
            });
            
            ordersList.innerHTML = ordersHTML;
        }

        // --- Checkout and Order Logic ---

        window.handleCheckout = function() {
            if (window.cart.length === 0) return showMessage("Your cart is empty!");
            document.getElementById('checkout-modal').classList.remove('hidden');
        }

        window.hideCheckoutModal = function() {
            document.getElementById('checkout-modal').classList.add('hidden');
        }

        window.placeOrder = async function() {
            if (!window.userId || window.cart.length === 0 || !window.isFirebaseReady) return showMessage("Authentication or cart error.");
            hideCheckoutModal();
            showLoading();

            const subtotal = window.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const total = subtotal + DELIVERY_FEE;
            
            const orderData = {
                userId: window.userId,
                items: window.cart,
                subtotal: subtotal,
                deliveryFee: DELIVERY_FEE,
                total: total,
                status: 'Pending', // Initial status
                paymentMethod: document.getElementById('payment-method').value,
                createdAt: serverTimestamp(),
            };

            try {
                // 1. Add order to Firestore (Auto-generate ID)
                // Using doc(collectionRef) generates a new ID automatically
                const newOrderRef = doc(getOrdersCollectionRef());
                await setDoc(newOrderRef, orderData);

                // 2. Clear the cart
                await updateCartInFirestore([]);
                
                showMessage(`Order Placed! Total: $${total.toFixed(2)}`);
                navigateTo('account-view');
            } catch (error) {
                console.error("Failed to place order:", error);
                showMessage(`Order placement failed: ${error.message}`);
            }
            hideLoading();
        }


        // --- Backend Product Fetching (Simulated/Mocked) ---
        
        async function fetchProducts(category = 'all', query = '') {
            const productGrid = document.getElementById('product-grid');
            
            // Set up loading state visually (clear existing products and show placeholders/message)
            productGrid.innerHTML = `
                <div class="w-full h-48 bg-gray-200 rounded-xl animate-pulse"></div>
                <div class="w-full h-48 bg-gray-200 rounded-xl animate-pulse"></div>
                <div class="w-full h-48 bg-gray-200 rounded-xl animate-pulse"></div>
                <div class="w-full h-48 bg-gray-200 rounded-xl animate-pulse"></div>
            `;
            
            // Highlight active category
            document.querySelectorAll('.category-item').forEach(item => {
                if (item.dataset.category === category) {
                    item.classList.add('bg-green-600', 'text-white');
                    item.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                } else {
                    item.classList.remove('bg-green-600', 'text-white');
                    item.classList.add('bg-gray-100', 'hover:bg-gray-200');
                }
            });

            // Simulate a network delay
            await new Promise(resolve => setTimeout(resolve, 300));

            let products = MOCK_PRODUCTS;

            // 1. Filter by Category
            if (category !== 'all') {
                products = products.filter(p => p.category === category);
            }

            // 2. Filter by Search Query (not implemented for mock data)

            let productHTML = '';
            if (products.length === 0) {
                 productHTML = '<p class="text-center text-gray-500 col-span-full py-10">No products found for this category.</p>';
            } else {
                products.forEach(p => {
                    productHTML += `
                        <div class="product-card bg-white rounded-xl overflow-hidden shadow-md p-2 flex flex-col justify-between">
                            <img src="${p.imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/150x150/f0f0f0/888888?text=Product';" alt="${p.name}" class="w-full h-24 object-cover rounded-lg mb-2">
                            <div class="flex-grow">
                                <p class="text-xs font-medium truncate">${p.name}</p>
                                <p class="text-sm font-bold text-green-600 mb-2">$${p.price.toFixed(2)}</p>
                            </div>
                            <button onclick="addToCart({id: '${p.id}', name: '${p.name}', price: ${p.price}, imageUrl: '${p.imageUrl}'})" class="w-full bg-red-500 text-white text-xs p-1 rounded-lg hover:bg-red-600 transition">
                                Add to Cart
                            </button>
                        </div>
                    `;
                });
            }

            productGrid.innerHTML = productHTML;
        }

        // Attach event listeners to category items
        document.querySelectorAll('.category-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                fetchProducts(item.dataset.category);
            });
        });

        // --- Initializer ---
        window.addEventListener('load', initAuth);

    </script>
</body>
</html>
